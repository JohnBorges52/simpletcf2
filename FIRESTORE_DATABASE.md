# Firestore Database Structure Documentation

## Overview

This document describes the Firestore database structure for the SimpleTCF2 application. The database stores user information and tracks question responses for reading and listening practice.

## Collections

### 1. Users Collection: `/users/{userId}`

Stores user account information.

#### Document ID
The document ID is the Firebase Authentication user UID.

#### Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `email` | string | Yes | User's email address |
| `displayName` | string | Yes | User's display name |
| `createdAt` | timestamp | Yes | Account creation timestamp |
| `lastLoginAt` | timestamp | Yes | Last login timestamp |
| `plan` | string | No | User's subscription plan (default: "free") |
| `renewalDate` | string | No | Subscription renewal date |

#### Example Document

```json
{
  "email": "user@example.com",
  "displayName": "John Doe",
  "createdAt": "2024-01-15T10:30:00Z",
  "lastLoginAt": "2024-01-20T14:25:00Z",
  "plan": "premium",
  "renewalDate": "2024-02-15"
}
```

#### Security Rules

- Users can read their own document
- Users can create/update their own document
- Users cannot delete their document (prevents accidental deletion)
- Email and displayName are required fields

---

### 2. Question Responses Collection: `/questionResponses/{responseId}`

Stores logs of all question responses from users for both reading and listening practice.

#### Document ID
Auto-generated by Firestore using `addDoc()`.

#### Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `userId` | string | Yes | Firebase Auth user UID |
| `questionId` | string | Yes | Unique identifier for the question (e.g., "tcfw03q0001") |
| `questionType` | string | Yes | Type of question: "reading" or "listening" |
| `testId` | string | No | Test identifier (e.g., "test1") |
| `questionNumber` | string | Yes | Question number within the test |
| `weight` | number | Yes | Question difficulty weight/points |
| `selectedOption` | string | Yes | User's selected answer (e.g., "A", "B", "C", "D") |
| `isCorrect` | boolean | Yes | Whether the answer was correct |
| `answeredAt` | timestamp | Yes | When the question was answered (server timestamp) |
| `timeSpent` | number | No | Time spent on question in seconds |

#### Example Document

```json
{
  "userId": "abc123xyz456",
  "questionId": "tcfw03q0001",
  "questionType": "listening",
  "testId": "test1",
  "questionNumber": "0001",
  "weight": 3,
  "selectedOption": "B",
  "isCorrect": true,
  "answeredAt": "2024-01-20T14:25:30Z",
  "timeSpent": 45
}
```

#### Security Rules

- Users can read their own responses (where `userId` matches their UID)
- Users can create responses for themselves
- Responses are immutable (cannot be updated or deleted) to maintain log integrity
- Required fields: userId, questionId, questionType, selectedOption, isCorrect

---

## Database Service API

The application provides a JavaScript service layer (`db-service.js`) with the following functions:

### User Management

#### `saveUser(userId, userData)`
Creates or updates a user document.

**Parameters:**
- `userId` (string): Firebase Auth user UID
- `userData` (object): User data object
  - `email` (string): User's email
  - `displayName` (string): User's display name
  - `createdAt` (timestamp, optional): Creation time
  - `plan` (string, optional): Subscription plan
  - `renewalDate` (string, optional): Renewal date

**Returns:** Promise<void>

**Example:**
```javascript
await window.dbService.saveUser(user.uid, {
  email: user.email,
  displayName: user.displayName || "User"
});
```

#### `getUser(userId)`
Retrieves user data from Firestore.

**Parameters:**
- `userId` (string): Firebase Auth user UID

**Returns:** Promise<Object|null> - User data or null if not found

**Example:**
```javascript
const userData = await window.dbService.getUser(user.uid);
console.log(userData.displayName);
```

### Question Response Logging

#### `logQuestionResponse(responseData)`
Logs a question response to Firestore.

**Parameters:**
- `responseData` (object):
  - `questionId` (string): Question identifier
  - `questionType` (string): "reading" or "listening"
  - `testId` (string, optional): Test identifier
  - `questionNumber` (string): Question number
  - `weight` (number): Question weight/points
  - `selectedOption` (string): Selected answer letter
  - `isCorrect` (boolean): Whether answer was correct
  - `timeSpent` (number, optional): Time spent in seconds

**Returns:** Promise<string> - Document ID of created response

**Example:**
```javascript
await window.dbService.logQuestionResponse({
  questionId: "tcfw03q0001",
  questionType: "listening",
  testId: "test1",
  questionNumber: "0001",
  weight: 3,
  selectedOption: "B",
  isCorrect: true
});
```

### Statistics Retrieval

#### `getUserStatistics(userId, options)`
Retrieves aggregated statistics for a user.

**Parameters:**
- `userId` (string): Firebase Auth user UID
- `options` (object, optional):
  - `questionType` (string): Filter by "reading" or "listening"
  - `limit` (number): Maximum number of responses to retrieve

**Returns:** Promise<Object> - Statistics object with:
- `totalResponses`: Total number of responses
- `correctResponses`: Number of correct responses
- `incorrectResponses`: Number of incorrect responses
- `accuracy`: Accuracy percentage (string)
- `byQuestionType`: Statistics grouped by question type
- `byWeight`: Statistics grouped by question weight
- `responses`: Array of response objects

**Example:**
```javascript
const stats = await window.dbService.getUserStatistics(user.uid, {
  questionType: "listening"
});
console.log(`Accuracy: ${stats.accuracy}%`);
console.log(`Questions answered: ${stats.totalResponses}`);
```

#### `getRecentResponses(userId, limitCount)`
Retrieves recent question responses for a user.

**Parameters:**
- `userId` (string): Firebase Auth user UID
- `limitCount` (number): Number of responses to retrieve (default: 10)

**Returns:** Promise<Array> - Array of response objects

**Example:**
```javascript
const recent = await window.dbService.getRecentResponses(user.uid, 20);
recent.forEach(response => {
  console.log(`Question ${response.questionNumber}: ${response.isCorrect ? 'Correct' : 'Incorrect'}`);
});
```

---

## Integration Points

### 1. User Registration/Login

When a user registers or logs in, their data is automatically saved to Firestore via the `onAuthStateChanged` listener in `config.js`:

```javascript
onAuthStateChanged(auth, async (user) => {
  if (user && user.emailVerified) {
    // Save/update user in Firestore
    await window.dbService.saveUser(user.uid, {
      email: user.email,
      displayName: user.displayName || "User",
      createdAt: user.metadata.creationTime ? new Date(user.metadata.creationTime) : null,
    });
  }
});
```

### 2. Question Response Logging

When a user confirms an answer in reading or listening practice, the response is logged to Firestore:

**In `reading.js`:**
```javascript
function confirmAnswer(q) {
  // ... answer validation logic ...
  
  // Log to Firestore
  if (window.dbService && window.dbService.logQuestionResponse) {
    const selectedLetter = q.alternatives?.[q.userAnswerIndex]?.letter || "";
    window.dbService.logQuestionResponse({
      questionId: q.question_ID || q.id || "unknown",
      questionType: "reading",
      testId: q.test_id || null,
      questionNumber: q.question_number || q.overall_question_number?.toString() || "",
      weight: q.weight_points || 0,
      selectedOption: selectedLetter,
      isCorrect: isCorrect,
    }).catch(err => {
      console.warn("Failed to log reading response to Firestore:", err);
    });
  }
}
```

**In `listening.js`:**
```javascript
function confirmAnswer(q) {
  // ... answer validation logic ...
  
  // Log to Firestore
  if (window.dbService && window.dbService.logQuestionResponse) {
    const selectedLetter = q.alternatives?.[q.userAnswerIndex]?.letter || "";
    window.dbService.logQuestionResponse({
      questionId: q.question_ID || q.id || "unknown",
      questionType: "listening",
      testId: q.test_id || null,
      questionNumber: q.question_number || q.overall_question_number?.toString() || "",
      weight: q.weight_points || 0,
      selectedOption: selectedLetter,
      isCorrect: isCorrect,
    }).catch(err => {
      console.warn("Failed to log listening response to Firestore:", err);
    });
  }
}
```

### 3. Profile Statistics Display

The profile page displays statistics fetched from Firestore:

**In `profile.js`:**
```javascript
async function seedKpis() {
  try {
    const auth = await window.__authReady;
    if (auth && auth.currentUser && window.dbService) {
      const stats = await window.dbService.getUserStatistics(auth.currentUser.uid);
      
      if (stats) {
        answered = stats.totalResponses || 0;
        accuracy = stats.accuracy ? `${stats.accuracy}%` : "â€”";
      }
    }
  } catch (error) {
    console.error("Failed to load statistics from Firestore:", error);
  }
  
  // Update UI elements
  $("#kpiAnswered") && ($("#kpiAnswered").textContent = answered);
  $("#kpiAccuracy") && ($("#kpiAccuracy").textContent = accuracy);
}
```

---

## Security Considerations

### Firestore Security Rules

The security rules ensure:

1. **Users can only access their own data** - All queries are filtered by `userId == request.auth.uid`
2. **Data validation** - Required fields are enforced at the database level
3. **Immutable logs** - Question responses cannot be modified or deleted after creation
4. **Type checking** - Field types are validated (e.g., `isCorrect` must be boolean)

### Best Practices

1. **Always use server timestamps** - Use `serverTimestamp()` instead of client-side dates to prevent time manipulation
2. **Validate data before writing** - The service layer validates data before sending to Firestore
3. **Handle errors gracefully** - All database operations are wrapped in try-catch blocks
4. **Use indexes for queries** - Common queries (by userId, by questionType) should have composite indexes

---

## Firestore Indexes

The following composite indexes should be created in the Firebase Console:

### Collection: `questionResponses`

1. **User Statistics Query:**
   - Fields: `userId` (Ascending), `answeredAt` (Descending)
   - Purpose: Retrieve user's responses ordered by date

2. **Question Type Filter:**
   - Fields: `userId` (Ascending), `questionType` (Ascending), `answeredAt` (Descending)
   - Purpose: Filter responses by question type (reading/listening)

3. **Weight Analysis:**
   - Fields: `userId` (Ascending), `weight` (Ascending), `answeredAt` (Descending)
   - Purpose: Analyze performance by question difficulty

These indexes will be automatically created when you run the queries for the first time. Firebase will provide a link in the console to create them.

---

## Future Enhancements

Potential improvements to the database structure:

1. **Real Test Tracking** - Add a `realTests` collection to track complete test sessions
2. **Study Streaks** - Calculate consecutive days of practice based on `answeredAt` timestamps
3. **Time Analytics** - Track and analyze `timeSpent` per question to identify areas needing improvement
4. **Performance Trends** - Add daily/weekly aggregations for chart visualization
5. **Leaderboards** - Add a public collection (with privacy controls) for anonymous leaderboards
6. **Question Feedback** - Allow users to report issues with questions
7. **Study Goals** - Store user-defined goals and progress tracking

---

## Deployment Checklist

Before deploying to production:

- [ ] Deploy Firestore security rules: `firebase deploy --only firestore:rules`
- [ ] Create necessary indexes in Firebase Console
- [ ] Test user registration flow
- [ ] Test question response logging for both reading and listening
- [ ] Test profile statistics display
- [ ] Verify security rules prevent unauthorized access
- [ ] Monitor Firestore usage and costs
- [ ] Set up billing alerts
- [ ] Configure backup/export schedule (optional)

---

## Support

For issues or questions:
- Check Firebase Console for error logs
- Review browser console for client-side errors
- Check Firestore Rules simulator in Firebase Console
- Review this documentation for API usage

---

**Last Updated:** January 2024  
**Version:** 1.0.0
